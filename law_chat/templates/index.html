<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>判例チャットアプリ</title>
        <!-- Bootstrap 5のCDN（CSS） -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        
        <!-- Bootstrap Icons（アイコン使いたい時） -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    </head>
    <body>
        <div class="container">
            <h1 class="text-center">RAG Chat</h1>
            <div id="chat-box">

            </div>
            <input id="message" type="text" placeholder="メッセージを入力">
            <button onclick="sendMessage()">送信</button>
        </div>
        

        <script>
            let socket = io();
            let responses = {}; // 各メッセージのIDごとにレスポンスを管理

            let chatHistory = [];

            function sendMessage() {
                let msg = document.getElementById("message").value; 
                if(!msg.trim()) return; // 空メッセージを送らないように
                document.getElementById("message").value = ""; // 入力欄クリア
                
                // ユーザーメッセージを追加
                let chatBox = document.getElementById("chat-box");
                let userMessage = document.createElement("p")
                userMessage.className = "message user";
                userMessage.innerHTML = "<b>あなた:</b>" + msg;

                chatBox.appendChild(userMessage);
                chatBox.scrollTop = chatBox.scrollHeight;

                // 履歴に追加
                chatHistory.push({role: "user",text:msg});
                if(chatHistory.length > 6) chatHistory.shift(); // 最新6件まで保持

                // WebSocket を使ってサーバーにメッセージを送信
                socket.emit("chat_message", {
                    message: msg,
                    history: chatHistory
                });
            }

            socket.on("response_start", function(data) {
                let chatBox = document.getElementById("chat-box");
                let gptMessage =document.createElement("p");

                gptMessage.className = "message gpt";
                gptMessage.id = "msg-" + data.id;
                gptMessage.innerHTML = "<b>GPT:</b>";

                chatBox.appendChild(gptMessage);
                responses[data.id] = gptMessage;

                // 履歴に追加
                chatHistory.push({role:"gpt", text:""});
            });

            // チャンク受信
            socket.on("response_chunk", function(data){
                if (responses[data.id]){
                    responses[data.id].innerHTML += data.text;

                    // 履歴の最新のGPTのメッセージを更新
                    chatHistory[chatHistory.length - 1].text += data.text;
                }
            });

            // メッセージ終了
            socket.on("response_end", function(data){
                if(responses[data.id]){
                    delete responses[data.id] // メモリ開放
                }
                document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
            })
        </script>
        <!-- Bootstrap 5のCDN（JS） -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>